<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>투자 프로그램</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar">
  <a href="index.html">홈</a>
  <a href="admin.html">관리자</a>
</nav>

<h2>투자자 이름 입력</h2>
<input id="username" placeholder="이름 입력" />
<button id="startBtn">시작하기</button>

<hr />

<h3 id="money"></h3>
<h2>팀 리스트</h2>
<div id="teams"></div>

<script type="module">
import { db } from "./firebase.js";
import {
  doc, setDoc, getDoc,
  collection, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const startBtn = document.getElementById("startBtn");
const usernameInput = document.getElementById("username");
const moneyEl = document.getElementById("money");
const teamsEl = document.getElementById("teams");

const userName = localStorage.getItem("user");

// 1️⃣ 사용자 생성
startBtn.onclick = async () => {
  const name = usernameInput.value.trim();
  if (!name) return alert("이름 입력");

  try {
    // 기존 사용자 확인
    const userDoc = await getDoc(doc(db, "users", name));
    if (userDoc.exists()) {
      // 이미 존재하는 사용자는 로그인만
      localStorage.setItem("user", name);
      location.reload();
      return;
    }

    // 새 사용자 생성
    await setDoc(doc(db, "users", name), {
      name,
      remainingMoney: 10000000,
      createdAt: new Date()
    });

    localStorage.setItem("user", name);
    location.reload();
  } catch (error) {
    console.error("사용자 생성 오류:", error);
    alert("사용자 생성 중 오류가 발생했습니다");
  }
};

// 2️⃣ 남은 투자금 표시
async function loadMoney() {
  if (!userName) return;
  try {
    const snap = await getDoc(doc(db, "users", userName));
    if (snap.exists()) {
      const userData = snap.data();
      const remainingMoney = userData.remainingMoney || 0;
      moneyEl.innerText = `남은 투자금: ${remainingMoney.toLocaleString()}원`;
    } else {
      // 사용자 정보가 없으면 로그아웃
      localStorage.removeItem("user");
      location.reload();
    }
  } catch (error) {
    console.error("투자금 로드 오류:", error);
    moneyEl.innerText = "투자금 정보를 불러올 수 없습니다";
  }
}

// 3️⃣ 팀 리스트 실시간 표시
onSnapshot(collection(db, "teams"), snapshot => {
  teamsEl.innerHTML = "";
  snapshot.forEach(docu => {
    const team = docu.data();
    const totalInvestment = team.totalInvestment || 0;
    teamsEl.innerHTML += `
      <div style="border:1px solid #ccc; margin:10px; padding:10px"
           onclick="location.href='team.html?id=${docu.id}'">
        <b>${team.name}</b><br/>
        총 투자금: ${totalInvestment.toLocaleString()}원
      </div>
    `;
  });
});

loadMoney();
</script>

</body>
</html>
