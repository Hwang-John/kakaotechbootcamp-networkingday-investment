<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¹´ì¹´ì˜¤í…Œí¬ ë¶€íŠ¸ìº í”„ íˆ¬ì í”„ë¡œê·¸ë¨</title>
  <link rel="stylesheet" href="style.css?v=20260130-5" />
</head>
<body class="home-dashboard">

   <!-- ê°€ì¥ ìƒë‹¨ì˜ ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì„¹ì…˜ -->
    <header class="main-header">
        <img src="https://hwang-john.github.io/image/%EC%B9%B4%ED%85%8C%EB%B6%80%20%EB%A1%9C%EA%B3%A0.png" alt="ì—…ë¡œë“œí•œ ì´ë¯¸ì§€" class="header-image" />
        <img src="https://hwang-john.github.io/image/ChatGPT%20Image%202026%EB%85%84%201%EC%9B%94%2028%EC%9D%BC%20%EC%98%A4%ED%9B%84%2005_24_03.png" alt="ì—…ë¡œë“œí•œ ì´ë¯¸ì§€" class="header-image2" />
    </header>

<div class="home-sticky-stack">
  <h1 class="header-title">
    ì¹´ì¹´ì˜¤í…Œí¬ ë¶€íŠ¸ìº í”„ ë„¤íŠ¸ì›Œí‚¹ ë°ì´ <br>
    ì¹´í…Œë¶€ ë¹Œë” í”„ë¡œê·¸ë¨<br>
    íˆ¬ì ì‹œë®¬ë ˆì´ì…˜ ê²Œì„ğŸš€
  </h1>
  <nav class="navbar">
    <a href="index.html" class="nav-home">í™ˆ</a>
    <a href="admin.html" class="nav-admin">ê´€ë¦¬ì</a>
    <button id="logoutBtn" type="button" class="nav-button" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>

  <div class="sticky-panel" id="stickyPanel">

    <div id="loginSection">
      <div class="team-login-row">
        <span class="team-login-label">íŒ€ ë²ˆí˜¸ ì…ë ¥</span>
        <input id="username" class="team-login-input" placeholder="ì˜ˆì‹œ_1íŒ€" />
        <button id="startBtn" class="btn btn-primary team-login-btn">íˆ¬ì ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>
    <p id="currentTeam" class="current-team" style="display: none;"></p>

    <hr />

    <div id="progressBar">
      <div></div>
      <span id="currentValue">10,000,000ì›</span>
    </div>
    <div class="progress-labels">
      <span id="startLabel">0ì›</span>
      <span id="endLabel">10,000,000ì›</span>
    </div>

    <h3 id="money"></h3>
  </div>
</div>

<div id="investmentClosedMessage" style="display:none; padding:40px 20px; text-align:center; font-size:24px; font-weight:700;">
  íˆ¬ìê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
</div>

<div id="teamListSection">
  <h2>íŒ€ ë¦¬ìŠ¤íŠ¸</h2>
  <div id="teams"></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import {
  doc, setDoc, getDoc,
  collection, onSnapshot, query, where
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const startBtn = document.getElementById("startBtn");
const usernameInput = document.getElementById("username");
const moneyEl = document.getElementById("money");
const teamsEl = document.getElementById("teams");
const loginSection = document.getElementById("loginSection");
const currentTeamEl = document.getElementById("currentTeam");
const logoutBtn = document.getElementById("logoutBtn");
const investmentClosedMessage = document.getElementById("investmentClosedMessage");
const teamListSection = document.getElementById("teamListSection");
const mainHeader = document.querySelector(".main-header");
const stickyPanel = document.getElementById("stickyPanel");
const progressBar = document.getElementById("progressBar");
const progressLabels = document.querySelector(".progress-labels");
const moneyTitle = document.getElementById("money");

const investmentSettingRef = doc(db, "settings", "investment");
let isInvestmentOpen = true;

const userName = localStorage.getItem("user");

function updateLoginUI(name) {
  if (name) {
    loginSection.style.display = "none";
    currentTeamEl.style.display = "block";
    currentTeamEl.innerText = `í˜„ì¬ ë¡œê·¸ì¸ íŒ€: ${name}`;
    logoutBtn.style.display = "inline-flex";
  } else {
    loginSection.style.display = "block";
    currentTeamEl.style.display = "none";
    currentTeamEl.innerText = "";
    logoutBtn.style.display = "none";
  }
}

updateLoginUI(userName);

function applyInvestmentStatusUI() {
  if (isInvestmentOpen) {
    investmentClosedMessage.style.display = "none";
    if (mainHeader) mainHeader.style.display = "";
    if (teamListSection) teamListSection.style.display = "";
    if (stickyPanel) stickyPanel.style.display = "";
    if (progressBar) progressBar.style.display = "";
    if (progressLabels) progressLabels.style.display = "";
    if (moneyTitle) moneyTitle.style.display = "";
    return;
  }

  investmentClosedMessage.style.display = "block";
  if (mainHeader) mainHeader.style.display = "none";
  if (teamListSection) teamListSection.style.display = "none";
  if (stickyPanel) stickyPanel.style.display = "none";
  if (progressBar) progressBar.style.display = "none";
  if (progressLabels) progressLabels.style.display = "none";
  if (moneyTitle) moneyTitle.style.display = "none";
}

onSnapshot(investmentSettingRef, (snap) => {
  isInvestmentOpen = snap.exists() ? !!snap.data().isOpen : true;
  applyInvestmentStatusUI();
});

// ë¡œê·¸ì•„ì›ƒ
logoutBtn.onclick = () => {
  localStorage.removeItem("user");
  updateLoginUI("");
  location.reload();
};

// 1ï¸âƒ£ ì‚¬ìš©ì ìƒì„±
startBtn.onclick = async () => {
  const name = usernameInput.value.trim();
  if (!name) return alert("ì´ë¦„ ì…ë ¥");

  try {
    // ê¸°ì¡´ ì‚¬ìš©ì í™•ì¸
    const userDoc = await getDoc(doc(db, "users", name));
    if (userDoc.exists()) {
      // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ë§Œ
      localStorage.setItem("user", name);
      updateLoginUI(name);
      location.reload();
      return;
    }

    // ìƒˆ ì‚¬ìš©ì ìƒì„±
    await setDoc(doc(db, "users", name), {
      name,
      remainingMoney: 10000000,
      createdAt: new Date()
    });

    localStorage.setItem("user", name);
    updateLoginUI(name);
    location.reload();
  } catch (error) {
    console.error("ì‚¬ìš©ì ìƒì„± ì˜¤ë¥˜:", error);
    alert("ì‚¬ìš©ì ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
  }
};

// 2ï¸âƒ£ ë‚¨ì€ íˆ¬ìê¸ˆ í‘œì‹œ
async function loadMoney() {
  if (!userName) return;

  try {
    const snap = await getDoc(doc(db, "users", userName));
    if (snap.exists()) {
      const userData = snap.data();
      const remainingMoney = userData.remainingMoney || 0;

      // 1ï¸âƒ£ íˆ¬ìê¸ˆ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      moneyEl.innerText = `ë‚¨ì€ íˆ¬ìê¸ˆ: ${remainingMoney.toLocaleString()}ì›`;

      // 2ï¸âƒ£ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      const progressBar = document.querySelector("#progressBar div");
      const progress = (remainingMoney / 10000000) * 100; // ì§„í–‰ë¥  ê³„ì‚°
      progressBar.style.width = `${progress}%`;

      // 3ï¸âƒ£ ê¸ˆì•¡ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      const currentValueEl = document.getElementById("currentValue");
      const progressBarElement = document.getElementById("progressBar");
      const barWidth = progressBarElement.offsetWidth;
      const leftPosition = (progress / 100) * barWidth; // ìœ„ì¹˜ ê³„ì‚°
      currentValueEl.style.left = `${leftPosition}px`;
      currentValueEl.innerText = `${remainingMoney.toLocaleString()}ì›`;
    } else {
      localStorage.removeItem("user");
      location.reload();
    }
  } catch (error) {
    console.error("íˆ¬ìê¸ˆ ë¡œë“œ ì˜¤ë¥˜:", error);
    moneyEl.innerText = "íˆ¬ìê¸ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
  }
}

let investedTeamIds = new Set();
let investedAmounts = new Map();
let latestTeams = [];

function renderTeams() {
  teamsEl.innerHTML = "";
  latestTeams.forEach(({ id, data }) => {
    const team = data;
    const isInvested = investedTeamIds.has(id);
    const badgeText = isInvested ? "íˆ¬ì ì™„ë£Œ" : "ë¯¸íˆ¬ì";
    const badgeClass = isInvested ? "badge-invested" : "badge-not-invested";
    const myAmount = investedAmounts.get(id) || 0;
    const teamName = team.name || "ì´ë¦„ ì—†ìŒ";

    teamsEl.innerHTML += `
      <div class="team-card${isInvested ? " team-card-disabled" : ""}" data-team-id="${id}">
        <div class="team-row">
          <span class="team-name">${teamName}</span>
          <span class="badge ${badgeClass}">${badgeText}</span>
          <span class="my-invest">ë‚´ íˆ¬ìê¸ˆ: ${myAmount.toLocaleString()}ì›</span>
        </div>
      </div>
    `;
  });
}

// 3ï¸âƒ£ íŒ€ ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ í‘œì‹œ
onSnapshot(collection(db, "teams"), snapshot => {
  latestTeams = [];
  snapshot.forEach(docu => {
    latestTeams.push({ id: docu.id, data: docu.data() });
  });
  renderTeams();
});

// 4ï¸âƒ£ ë‚´ íˆ¬ì ì—¬ë¶€ ì‹¤ì‹œê°„ í‘œì‹œ
if (userName) {
  const q = query(collection(db, "investments"), where("user", "==", userName));
  onSnapshot(q, snapshot => {
    investedTeamIds = new Set();
    investedAmounts = new Map();
    snapshot.forEach(docu => {
      const invest = docu.data();
      if (invest.teamId) {
        investedTeamIds.add(invest.teamId);
        investedAmounts.set(invest.teamId, invest.amount || 0);
      }
    });
    renderTeams();
  });
}

loadMoney();

// íˆ¬ì ì™„ë£Œ íŒ€ ì§„ì… ì°¨ë‹¨
teamsEl.addEventListener("click", (event) => {
  const card = event.target.closest(".team-card");
  if (!card) return;
  const id = card.dataset.teamId;
  if (!id) return;

  if (!isInvestmentOpen) {
    alert("íˆ¬ìê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }
  if (investedTeamIds.has(id)) {
    alert("ì´ë¯¸ íˆ¬ìë¥¼ ì™„ë£Œí•œ íŒ€ ì…ë‹ˆë‹¤.");
    return;
  }
  location.href = `team.html?id=${id}`;
});
</script>

</body>
</html>
