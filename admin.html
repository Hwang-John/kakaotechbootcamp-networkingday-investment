<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자</title>
  <link rel="stylesheet" href="style.css?v=20260130-1" />
</head>
<body>

<!-- 내비게이션 바 -->
<nav class="navbar">
  <a href="index.html">홈</a>
  <a href="admin.html">관리자</a>
</nav>

<!-- 관리자 로그인 섹션 -->
<div id="loginContainer" style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 100px; min-height: calc(100vh - 100px);">
  <h2>관리자 페이지</h2>
  <p>비밀번호를 입력하세요.</p>
  <input id="passwordInput" type="password" placeholder="비밀번호" style="padding: 8px; width: 300px; margin-bottom: 10px; font-size: 16px;" />
  <button id="loginButton" style="padding: 10px 20px; background-color: blue; color: white; border: none; border-radius: 5px; cursor: pointer;">확인</button>
  <p id="errorText" style="color: red; margin-top: 10px; display: none;">잘못된 비밀번호입니다. 다시 시도하세요.</p>
</div>

<!-- 관리자 콘텐츠 (초기에 숨김 처리) -->
<div id="adminContent" style="display: none;">
  <h2>관리자 페이지</h2>

  <!-- 팀 생성 섹션 -->
  <div style="background-color:#f5f5f5; padding:20px; margin-bottom:20px; border-radius:5px">
    <div class="team-create-row">
      <h3 class="team-create-title">새 팀 등록</h3>
      <input id="teamName" placeholder="팀 이름" class="team-create-input" />
      <button id="addTeamBtn" class="team-create-button">팀 추가</button>
    </div>
  </div>

  <div class="dashboard-controls">
    <button id="sortByInvestment">투자 많이 받은 순으로 나열</button>
  </div>

  <div id="teamList"></div>

  <!-- 팀별 투자 현황 -->
  <h3>팀별 투자 현황</h3>
  <div id="list"></div>
  <button id="resetBtn" style="background-color:#ff4444; color:white; padding:10px 20px; margin:24px 0 0; cursor:pointer; border:none; border-radius:5px">전체 데이터 초기화</button>
</div>

<script type="module">
  // Firebase 초기화
  import { db } from "./firebase.js";
  import { collection, onSnapshot, getDocs, deleteDoc, doc, writeBatch, setDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // 전역 설정: 비밀번호
  const ADMIN_PASSWORD = "1234#"; // 적절히 강력한 비밀번호로 설정하세요.

  // DOM 요소 가져오기
  const loginContainer = document.getElementById("loginContainer");
  const adminContent = document.getElementById("adminContent");
  const passwordInput = document.getElementById("passwordInput");
  const loginButton = document.getElementById("loginButton");
  const errorText = document.getElementById("errorText");

  const list = document.getElementById("list");
  const resetBtn = document.getElementById("resetBtn");
  const addTeamBtn = document.getElementById("addTeamBtn");
  const teamNameInput = document.getElementById("teamName");
  const sortByInvestmentButton = document.getElementById("sortByInvestment");

  // 로그인 버튼 클릭 이벤트
  loginButton.onclick = () => {
    const enteredPassword = passwordInput.value;

    // 비밀번호 비교
    if (enteredPassword === ADMIN_PASSWORD) {
      // 성공
      loginContainer.style.display = "none"; // 로그인 폼 숨김
      adminContent.style.display = "block"; // 관리자 콘텐츠 표시
    } else {
      // 실패
      errorText.style.display = "block"; // 에러 메시지 표시
    }
  };

  // 팀 추가 버튼 핸들러
  addTeamBtn.onclick = async () => {
    const teamName = teamNameInput.value.trim();
    if (!teamName) {
      alert("팀 이름을 입력하세요.");
      return;
    }
    if (latestTeams.some((team) => (team.data.name || "").trim() === teamName)) {
      alert(`"${teamName}" 팀은 이미 등록되어 있습니다.`);
      return;
    }

    try {
      addTeamBtn.disabled = true;
      addTeamBtn.innerText = "추가 중...";

      const teamId = `team_${Date.now()}`;
      
      await setDoc(doc(db, "teams", teamId), {
        name: teamName,
        totalInvestment: 0,
        createdAt: new Date()
      });

      alert(`팀 "${teamName}"이 추가되었습니다!`);
      teamNameInput.value = "";

    } catch (error) {
      console.error("팀 추가 오류:", error);
      alert("팀 추가 중 오류가 발생했습니다: " + error.message);
    } finally {
      addTeamBtn.disabled = false;
      addTeamBtn.innerText = "팀 추가";
    }
  };

  // 전체 데이터 초기화 버튼 핸들러
  resetBtn.onclick = async () => {
    if (!confirm("정말로 모든 데이터를 초기화하시겠습니까?\n등록된 모든 팀들과 투자금액이 모두 초기화 되며 이 작업은 되돌릴 수 없습니다.")) {
      return;
    }

    try {
      resetBtn.disabled = true;
      resetBtn.innerText = "초기화 중...";

      const batch = writeBatch(db);
      const collectionNames = ["users", "teams", "investments"];

      for (const collectionName of collectionNames) {
        const snapshot = await getDocs(collection(db, collectionName));
        snapshot.forEach((docSnap) => {
          batch.delete(doc(db, collectionName, docSnap.id));
        });
      }

      await batch.commit();

      alert("초기화가 완료되었습니다!");
    } catch (error) {
      console.error("초기화 오류:", error);
      alert("초기화 중 오류가 발생했습니다: " + error.message);
    } finally {
      resetBtn.disabled = false;
      resetBtn.innerText = "전체 데이터 초기화";
    }
  };

  let latestTeams = [];
  let investmentsByTeam = new Map();

  function renderTeamInvestments(teams) {
    list.innerHTML = "";
    teams.forEach(({ id, data }, index) => {
      const team = data;
      const teamName = team.name || "이름 없음";
      const totalInvestment = team.totalInvestment || 0;
      const investments = investmentsByTeam.get(id) || [];
      const investorText = investments.length
        ? investments
            .map(({ investor, amount }) => (
              `<span class="investor-chip">${investor} ${amount.toLocaleString()}원</span>`
            ))
            .join(" ")
        : "없음";

      list.innerHTML += `
        <div class="team-invest-item">
          <div class="team-invest-header">
            <div class="team-info">
              <span class="team-chip">${teamName}</span>
              <div class="team-amount">${totalInvestment.toLocaleString()}원</div>
            </div>
            <button
              class="team-reset-btn"
              data-team-id="${id}"
              data-team-name="${teamName}"
            >
              팀 데이터 삭제
            </button>
          </div>
          <div class="team-investors">투자팀: ${investorText}</div>
        </div>`;
    });
  }

  // Firestore에서 팀 데이터를 실시간으로 받아오기
  onSnapshot(collection(db, "teams"), snapshot => {
    latestTeams = [];
    snapshot.forEach(docu => {
      latestTeams.push({ id: docu.id, data: docu.data() });
    });
    renderTeamInvestments(latestTeams);
  });

  // Firestore에서 투자 데이터를 실시간으로 받아오기
  onSnapshot(collection(db, "investments"), snapshot => {
    const nextMap = new Map();
    snapshot.forEach(docu => {
      const investment = docu.data();
      const teamId = investment.teamId;
      const investor = investment.user;
      const amount = Number(investment.amount) || 0;
      if (!teamId || !investor) return;

      if (!nextMap.has(teamId)) {
        nextMap.set(teamId, []);
      }
      nextMap.get(teamId).push({ investor, amount });
    });

    investmentsByTeam = nextMap;

    renderTeamInvestments(latestTeams);
  });
  
  // 투자 많이 받은 순서로 정렬
  sortByInvestmentButton.onclick = async () => {
    const q = query(collection(db, "teams"), orderBy("totalInvestment", "desc"));
    const snapshot = await getDocs(q);

    latestTeams = [];
    snapshot.forEach(docu => {
      latestTeams.push({ id: docu.id, data: docu.data() });
    });
    renderTeamInvestments(latestTeams);
  };

  // 팀별 데이터 삭제 버튼 핸들러 (이벤트 위임)
  list.addEventListener("click", async (event) => {
    const button = event.target.closest(".team-reset-btn");
    if (!button) return;

    const teamId = button.dataset.teamId;
    const teamName = button.dataset.teamName || "해당 팀";

    if (!teamId) return;

    if (!confirm(`정말로 "${teamName}"의 데이터를 삭제하시겠습니까?\n해당 팀과 투자 기록이 모두 삭제되며 이 작업은 되돌릴 수 없습니다.`)) {
      return;
    }

    try {
      button.disabled = true;
      button.innerText = "삭제 중...";

      const batch = writeBatch(db);

      // 팀 문서 삭제
      batch.delete(doc(db, "teams", teamId));

      // 해당 팀의 투자 기록 삭제
      const investmentsSnapshot = await getDocs(
        query(collection(db, "investments"), where("teamId", "==", teamId))
      );
      investmentsSnapshot.forEach((docSnap) => {
        batch.delete(doc(db, "investments", docSnap.id));
      });

      await batch.commit();

      alert(`"${teamName}" 데이터가 삭제되었습니다.`);
    } catch (error) {
      console.error("팀 데이터 삭제 오류:", error);
      alert("팀 데이터 삭제 중 오류가 발생했습니다: " + error.message);
    } finally {
      button.disabled = false;
      button.innerText = "팀 데이터 삭제";
    }
  });
</script>

</body>
</html>
