<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ì</title>
  <link rel="stylesheet" href="style.css?v=20260130-3" />
</head>
<body>

<!-- ê´€ë¦¬ì ì½˜í…ì¸  -->
<div id="adminContent">
  <div class="admin-sticky">
    <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
    <div id="investmentStatus" style="font-weight:600; margin:6px 0 12px;"></div>
    <div class="admin-action-row" style="display:flex; gap:6px; align-items:center; margin:10px 0 24px; flex-wrap: nowrap;">
      <nav class="navbar" style="margin: 0; padding: 0; background: transparent;">
        <a href="index.html" class="nav-home">í™ˆ</a>
        <button id="logoutAdminBtn" class="nav-admin" style="background:none; border:none; cursor:pointer; font:inherit; color:inherit;">ë¡œê·¸ì•„ì›ƒ</button>
      </nav>
      <button id="openInvestmentBtn" class="btn btn-success btn-inline">íˆ¬ì ì‹œì‘</button>
      <button id="closeInvestmentBtn" class="btn btn-danger btn-inline">íˆ¬ì ì¢…ë£Œ</button>
    </div>
  </div>

  <!-- íŒ€ ìƒì„± ì„¹ì…˜ -->
  <div style="background-color:#f5f5f5; padding:20px; margin-bottom:20px; border-radius:5px">
    <div class="team-create-row">
      <h3 class="team-create-title">ìƒˆ íŒ€ ë“±ë¡</h3>
      <input id="teamName" placeholder="íŒ€ ì´ë¦„" class="team-create-input" />
      <button id="addTeamBtn" class="team-create-button">íŒ€ ì¶”ê°€</button>
    </div>
  </div>

  <div id="teamList"></div>

  <!-- íŒ€ë³„ íˆ¬ìê¸ˆ í™•ì¸ -->
  <div class="team-toggle-header" style="display:flex; align-items:center; gap:8px;">
    <h3 style="margin:0;">ğŸ’° íŒ€ë³„ íˆ¬ìê¸ˆ í™•ì¸</h3>
    <button id="toggleTeamMoneyBtn" class="btn btn-inline btn-primary" style="height:28px; padding:0 10px; font-size:12px; border-radius:10px;">ì—´ê¸°</button>
  </div>
  <div id="teamMoneyPanel" style="display: block; margin-bottom: 4px;">
    <div id="teamMoneySummary" style="font-size: 14px; margin: 6px 0 10px; color: #1f2933;"></div>
    <div id="teamMoneyList"></div>
  </div>

  <!-- íŒ€ë³„ íˆ¬ì í˜„í™© -->
  <div class="team-toggle-header" style="display:flex; align-items:center; gap:8px; margin-top: 4px;">
    <h3 style="margin:0;">ğŸ† íˆ¬ì ìˆœìœ„ í™•ì¸</h3>
    <button id="toggleTeamRankingBtn" class="btn btn-inline btn-primary" style="height:28px; padding:0 10px; font-size:12px; border-radius:10px;">ë‹«ê¸°</button>
  </div>
  <div id="teamRankingPanel" style="display: block;">
    <div id="list"></div>
  </div>
  <button id="resetBtn" class="btn btn-danger">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
</div>

<script type="module">
  // Firebase ì´ˆê¸°í™”
  import { db } from "./firebase.js";
  import { collection, onSnapshot, getDocs, doc, writeBatch, setDoc, query, where, increment } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ì„¸ì…˜ í™•ì¸ - ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  function checkSession() {
    const token = sessionStorage.getItem("adminToken");
    const expiry = sessionStorage.getItem("adminTokenExpiry");

    if (!token || !expiry) {
      location.href = "index.html";
      return false;
    }

    const expiryTime = parseInt(expiry, 10);
    if (Date.now() > expiryTime) {
      // ì„¸ì…˜ ë§Œë£Œ
      sessionStorage.removeItem("adminToken");
      sessionStorage.removeItem("adminTokenExpiry");
      alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
      location.href = "index.html";
      return false;
    }

    return true;
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸
  if (!checkSession()) {
    throw new Error("Unauthorized");
  }

  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
  const logoutAdminBtn = document.getElementById("logoutAdminBtn");
  logoutAdminBtn.onclick = () => {
    sessionStorage.removeItem("adminToken");
    sessionStorage.removeItem("adminTokenExpiry");
    location.href = "index.html";
  };

  // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  const adminContent = document.getElementById("adminContent");

  const list = document.getElementById("list");
  const teamMoneyList = document.getElementById("teamMoneyList");
  const teamMoneySummary = document.getElementById("teamMoneySummary");
  const teamMoneyPanel = document.getElementById("teamMoneyPanel");
  const toggleTeamMoneyBtn = document.getElementById("toggleTeamMoneyBtn");
  const teamRankingPanel = document.getElementById("teamRankingPanel");
  const toggleTeamRankingBtn = document.getElementById("toggleTeamRankingBtn");
  const resetBtn = document.getElementById("resetBtn");
  const addTeamBtn = document.getElementById("addTeamBtn");
  const teamNameInput = document.getElementById("teamName");
  const openInvestmentBtn = document.getElementById("openInvestmentBtn");
  const closeInvestmentBtn = document.getElementById("closeInvestmentBtn");
  const investmentStatus = document.getElementById("investmentStatus");

  const investmentSettingRef = doc(db, "settings", "investment");

  // íˆ¬ì ì‹œì‘/ì¢…ë£Œ ì„¤ì •
  openInvestmentBtn.onclick = async () => {
    try {
      openInvestmentBtn.disabled = true;
      await setDoc(investmentSettingRef, { isOpen: true, updatedAt: new Date() }, { merge: true });
      alert("íˆ¬ìê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (error) {
      console.error("íˆ¬ì ì‹œì‘ ì˜¤ë¥˜:", error);
      alert("íˆ¬ì ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    } finally {
      openInvestmentBtn.disabled = false;
    }
  };

  closeInvestmentBtn.onclick = async () => {
    try {
      closeInvestmentBtn.disabled = true;
      await setDoc(investmentSettingRef, { isOpen: false, updatedAt: new Date() }, { merge: true });
      alert("íˆ¬ìê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (error) {
      console.error("íˆ¬ì ì¢…ë£Œ ì˜¤ë¥˜:", error);
      alert("íˆ¬ì ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    } finally {
      closeInvestmentBtn.disabled = false;
    }
  };

  // íŒ€ ì¶”ê°€ ë²„íŠ¼ í•¸ë“¤ëŸ¬
  addTeamBtn.onclick = async () => {
    const teamName = teamNameInput.value.trim();
    if (!teamName) {
      alert("íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    if (latestTeams.some((team) => (team.data.name || "").trim() === teamName)) {
      alert(`"${teamName}" íŒ€ì€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }

    try {
      addTeamBtn.disabled = true;
      addTeamBtn.innerText = "ì¶”ê°€ ì¤‘...";

      const teamId = `team_${Date.now()}`;

      await setDoc(doc(db, "teams", teamId), {
        name: teamName,
        totalInvestment: 0,
        createdAt: new Date()
      });

      alert(`íŒ€ "${teamName}"ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
      teamNameInput.value = "";

    } catch (error) {
      console.error("íŒ€ ì¶”ê°€ ì˜¤ë¥˜:", error);
      alert("íŒ€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    } finally {
      addTeamBtn.disabled = false;
      addTeamBtn.innerText = "íŒ€ ì¶”ê°€";
    }
  };

  // ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ë²„íŠ¼ í•¸ë“¤ëŸ¬
  resetBtn.onclick = async () => {
    if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në“±ë¡ëœ ëª¨ë“  íŒ€ë“¤ê³¼ íˆ¬ìê¸ˆì•¡ì´ ëª¨ë‘ ì´ˆê¸°í™” ë˜ë©° ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
      return;
    }

    try {
      resetBtn.disabled = true;
      resetBtn.innerText = "ì´ˆê¸°í™” ì¤‘...";

      const batch = writeBatch(db);
      const collectionNames = ["users", "teams", "investments"];

      for (const collectionName of collectionNames) {
        const snapshot = await getDocs(collection(db, collectionName));
        snapshot.forEach((docSnap) => {
          batch.delete(doc(db, collectionName, docSnap.id));
        });
      }

      await batch.commit();

      alert("ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    } catch (error) {
      console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
      alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    } finally {
      resetBtn.disabled = false;
      resetBtn.innerText = "ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”";
    }
  };

  let latestTeams = [];
  let latestUsers = [];
  let investmentsByTeam = new Map();
  let investmentsByUser = new Map();
  const INITIAL_BUDGET = 10000000;
  const TEAM_MONEY_PANEL_KEY = "adminTeamMoneyPanelOpen";
  const TEAM_RANKING_PANEL_KEY = "adminTeamRankingPanelOpen";

  if (toggleTeamMoneyBtn && teamMoneyPanel) {
    const savedOpenState = localStorage.getItem(TEAM_MONEY_PANEL_KEY);
    const isOpen = savedOpenState === null ? true : savedOpenState === "true";
    teamMoneyPanel.style.display = isOpen ? "block" : "none";
    toggleTeamMoneyBtn.innerText = isOpen ? "ë‹«ê¸°" : "ì—´ê¸°";

    toggleTeamMoneyBtn.addEventListener("click", () => {
      const isHidden = teamMoneyPanel.style.display === "none";
      teamMoneyPanel.style.display = isHidden ? "block" : "none";
      toggleTeamMoneyBtn.innerText = isHidden ? "ë‹«ê¸°" : "ì—´ê¸°";
      localStorage.setItem(TEAM_MONEY_PANEL_KEY, isHidden ? "true" : "false");
    });
  }

  if (toggleTeamRankingBtn && teamRankingPanel) {
    localStorage.setItem(TEAM_RANKING_PANEL_KEY, "true");
    const isOpen = true;
    teamRankingPanel.style.display = isOpen ? "block" : "none";
    toggleTeamRankingBtn.innerText = isOpen ? "ë‹«ê¸°" : "ì—´ê¸°";

    toggleTeamRankingBtn.addEventListener("click", () => {
      const isHidden = teamRankingPanel.style.display === "none";
      teamRankingPanel.style.display = isHidden ? "block" : "none";
      toggleTeamRankingBtn.innerText = isHidden ? "ë‹«ê¸°" : "ì—´ê¸°";
      localStorage.setItem(TEAM_RANKING_PANEL_KEY, isHidden ? "true" : "false");
    });
  }

  function renderTeamMoneyStatus() {
    if (!teamMoneyList) return;

    const sortedUsers = [...latestUsers].sort((a, b) => {
      const aInvested = investmentsByUser.get(a.data.name || a.id) || 0;
      const bInvested = investmentsByUser.get(b.data.name || b.id) || 0;
      return bInvested - aInvested;
    });

    let countActive = 0;
    let countNone = 0;
    let countDone = 0;

    teamMoneyList.innerHTML = "";

    sortedUsers.forEach(({ id, data }) => {
      const teamName = (data.name || id || "").trim() || "ì´ë¦„ ì—†ìŒ";
      const investedAmount = investmentsByUser.get(teamName) || 0;
      const remainingFromUser = Number(data.remainingMoney);
      const remainingAmount = Number.isFinite(remainingFromUser)
        ? remainingFromUser
        : Math.max(0, INITIAL_BUDGET - investedAmount);

      let statusText = "ë¯¸íˆ¬ì";
      let statusClass = "badge-not-invested";
      if (investedAmount > 0 && remainingAmount > 0) {
        statusText = "íˆ¬ìì¤‘";
        statusClass = "badge-invested";
        countActive += 1;
      } else if (remainingAmount <= 0 && investedAmount > 0) {
        statusText = "íˆ¬ì ì™„ë£Œ";
        statusClass = "badge-invested";
        countDone += 1;
      } else {
        countNone += 1;
      }

      teamMoneyList.innerHTML += `
        <div class="team-invest-item">
          <div class="team-invest-header">
            <div class="team-info">
              <span class="team-chip">${teamName}</span>
              <div class="team-amount">íˆ¬ìê¸ˆ: ${investedAmount.toLocaleString()}ì›</div>
              <div class="team-invest-stats">ë¯¸íˆ¬ìê¸ˆ: ${remainingAmount.toLocaleString()}ì›</div>
            </div>
            <span class="badge ${statusClass}">${statusText}</span>
          </div>
        </div>`;
    });

    if (teamMoneySummary) {
      teamMoneySummary.innerText = `í˜„ì¬ íˆ¬ìì¤‘ ${countActive}íŒ€ Â· ë¯¸íˆ¬ì ${countNone}íŒ€ Â· íˆ¬ì ì™„ë£Œ ${countDone}íŒ€`;
    }
  }

  function renderTeamInvestments(teams) {
    list.innerHTML = "";
    const sortedTeams = [...teams].sort((a, b) => {
      const aAmount = a.data.totalInvestment || 0;
      const bAmount = b.data.totalInvestment || 0;
      return bAmount - aAmount;
    });

    const amountCounts = new Map();
    sortedTeams.forEach(({ data }) => {
      const amount = data.totalInvestment || 0;
      amountCounts.set(amount, (amountCounts.get(amount) || 0) + 1);
    });

    let currentRank = 0;
    let prevAmount = null;

    sortedTeams.forEach(({ id, data }, index) => {
      const team = data;
      const teamName = team.name || "ì´ë¦„ ì—†ìŒ";
      const totalInvestment = team.totalInvestment || 0;
      const investments = investmentsByTeam.get(id) || [];
      const investorText = investments.length
        ? investments
            .map(({ investor, amount }) => (
              `<span class="investor-chip">${investor} ${amount.toLocaleString()}ì›</span>`
            ))
            .join(" ")
        : "ì—†ìŒ";
      if (prevAmount === null || totalInvestment !== prevAmount) {
        currentRank = index + 1;
        prevAmount = totalInvestment;
      }
      const isTie = (amountCounts.get(totalInvestment) || 0) > 1;
      const rankLabel = isTie ? `ê³µë™ ${currentRank}ìœ„` : `${currentRank}ìœ„`;

      list.innerHTML += `
        <div class="team-invest-item">
          <div class="team-invest-header">
            <div class="team-info">
              <span class="team-rank">
                ${currentRank === 1 ? '<span class="rank-medal" aria-label="ê¸ˆë©”ë‹¬">ğŸ¥‡</span>' : ""}
                ${currentRank === 2 ? '<span class="rank-medal" aria-label="ì€ë©”ë‹¬">ğŸ¥ˆ</span>' : ""}
                ${currentRank === 3 ? '<span class="rank-medal" aria-label="ë™ë©”ë‹¬">ğŸ¥‰</span>' : ""}
                ${rankLabel}
              </span>
              <span class="team-chip">${teamName}</span>
              <div class="team-amount">${totalInvestment.toLocaleString()}ì›</div>
            </div>
            <button
              class="team-reset-btn"
              data-team-id="${id}"
              data-team-name="${teamName}"
            >
              íŒ€ ë°ì´í„° ì‚­ì œ
            </button>
          </div>
          <div class="team-investors">íˆ¬ìíŒ€: ${investorText}</div>
        </div>`;
    });
  }

  // Firestoreì—ì„œ íŒ€ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•„ì˜¤ê¸°
  onSnapshot(collection(db, "teams"), snapshot => {
    latestTeams = [];
    snapshot.forEach(docu => {
      latestTeams.push({ id: docu.id, data: docu.data() });
    });
    renderTeamInvestments(latestTeams);
  });

  onSnapshot(collection(db, "users"), snapshot => {
    latestUsers = [];
    snapshot.forEach(docu => {
      latestUsers.push({ id: docu.id, data: docu.data() });
    });
    renderTeamMoneyStatus();
  });

  // Firestoreì—ì„œ íˆ¬ì ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•„ì˜¤ê¸°
  onSnapshot(collection(db, "investments"), snapshot => {
    const nextMap = new Map();
    const nextUserMap = new Map();
    snapshot.forEach(docu => {
      const investment = docu.data();
      const teamId = investment.teamId;
      const investor = investment.user;
      const amount = Number(investment.amount) || 0;
      if (!teamId || !investor) return;

      if (!nextMap.has(teamId)) {
        nextMap.set(teamId, []);
      }
      nextMap.get(teamId).push({ investor, amount });

      nextUserMap.set(investor, (nextUserMap.get(investor) || 0) + amount);
    });

    investmentsByTeam = nextMap;
    investmentsByUser = nextUserMap;

    renderTeamInvestments(latestTeams);
    renderTeamMoneyStatus();
  });

  // íˆ¬ì ìƒíƒœ ì‹¤ì‹œê°„ í‘œì‹œ
  onSnapshot(investmentSettingRef, (snap) => {
    const isOpen = snap.exists() ? !!snap.data().isOpen : true;
    investmentStatus.innerText = isOpen ? "í˜„ì¬ ìƒíƒœ: íˆ¬ì ì§„í–‰ ì¤‘" : "í˜„ì¬ ìƒíƒœ: íˆ¬ì ì¢…ë£Œ";
  });


  // íŒ€ë³„ ë°ì´í„° ì‚­ì œ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ì´ë²¤íŠ¸ ìœ„ì„)
  list.addEventListener("click", async (event) => {
    const button = event.target.closest(".team-reset-btn");
    if (!button) return;

    const teamId = button.dataset.teamId;
    const teamName = button.dataset.teamName || "í•´ë‹¹ íŒ€";

    if (!teamId) return;

    if (!confirm(`ì •ë§ë¡œ "${teamName}"ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ íŒ€ê³¼ íˆ¬ì ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ë©° ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
      return;
    }

    try {
      button.disabled = true;
      button.innerText = "ì‚­ì œ ì¤‘...";

      const batch = writeBatch(db);
      const refundByUser = new Map();

      // íŒ€ ë¬¸ì„œ ì‚­ì œ
      batch.delete(doc(db, "teams", teamId));

      // í•´ë‹¹ íŒ€ì˜ íˆ¬ì ê¸°ë¡ ì‚­ì œ
      const investmentsSnapshot = await getDocs(
        query(collection(db, "investments"), where("teamId", "==", teamId))
      );
      investmentsSnapshot.forEach((docSnap) => {
        const investment = docSnap.data() || {};
        const investor = investment.user;
        const amount = Number(investment.amount) || 0;
        if (investor && amount > 0) {
          refundByUser.set(investor, (refundByUser.get(investor) || 0) + amount);
        }
        batch.delete(doc(db, "investments", docSnap.id));
      });

      refundByUser.forEach((amount, investor) => {
        const userRef = doc(db, "users", investor);
        batch.set(
          userRef,
          { name: investor, remainingMoney: increment(amount) },
          { merge: true }
        );
      });

      await batch.commit();

      alert(`"${teamName}" ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
      console.error("íŒ€ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:", error);
      alert("íŒ€ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    } finally {
      button.disabled = false;
      button.innerText = "íŒ€ ë°ì´í„° ì‚­ì œ";
    }
  });
</script>

</body>
</html>
