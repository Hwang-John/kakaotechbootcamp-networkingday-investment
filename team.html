<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>팀 투자</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- 네비게이션 바 -->
<nav class="navbar">
  <a href="index.html">홈</a>
  <a href="admin.html">관리자</a>
</nav>

<!-- 팀 이름 및 투자 입력 -->
<h2 id="teamName">
  팀 이름 <span id="investmentBadge" class="badge"></span>
</h2>
<input id="amount" placeholder="투자금 (10만원 단위)" />
<button onclick="invest()">투자</button>

<script type="module">
import { db } from "./firebase.js";
import {
  doc, getDoc, updateDoc, setDoc, collection, runTransaction
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// 사용자 이름과 URL에서 팀 ID 가져오기
const user = localStorage.getItem("user");
const params = new URLSearchParams(location.search);
const teamId = params.get("id");

// null 체크 로직
if (!user) {
  alert("투자자 이름을 입력하여 시작하세요.");
  location.href = "index.html";
}

if (!teamId) {
  alert("잘못된 접근입니다");
  location.href = "index.html";
}

// Firestore 참조 생성
const teamRef = doc(db, "teams", teamId);
const userRef = doc(db, "users", user);

// 팀 데이터 로드 함수
async function loadTeam() {
  try {
    const snap = await getDoc(teamRef);

    if (!snap.exists()) {
      alert("존재하지 않는 팀입니다");
      location.href = "index.html";
      return;
    }

    const teamData = snap.data();
    const teamName = teamData.name;

    if (teamName === user) {
      alert("본인의 팀은 투자할 수 없습니다");
      location.href = "index.html";
      return;
    }

    document.getElementById("teamName").innerText = teamName;

    const investId = `${user}_${teamId}`;
    const investRef = doc(db, "investments", investId);
    const investSnap = await getDoc(investRef);

    const badgeElement = document.getElementById("investmentBadge");
    if (investSnap.exists()) {
      badgeElement.innerText = "투자 완료";
      badgeElement.classList.add("badge-invested");
    } else {
      badgeElement.innerText = "미투자";
      badgeElement.classList.add("badge-not-invested");
    }
  } catch (error) {
    console.error("팀 로드 오류:", error);
    alert("팀 정보를 불러올 수 없습니다");
  }
}

// 로드 팀 데이터 호출
loadTeam();

// 투자 로직
window.invest = async function () {
  const amount = Number(document.getElementById("amount").value);
  if (amount % 100000 !== 0) return alert("10만원 단위로만 입력 가능합니다");

  try {
    // Transaction을 사용하여 동시성 문제 방지
    await runTransaction(db, async (transaction) => {
      const investId = `${user}_${teamId}`;
      const investRef = doc(db, "investments", investId);

      // 중복 투자 확인
      const investSnap = await transaction.get(investRef);
      if (investSnap.exists()) {
        throw new Error("이미 투자한 팀입니다");
      }

      // 사용자 및 팀 정보 가져오기
      const userSnap = await transaction.get(userRef);
      if (!userSnap.exists()) {
        throw new Error("사용자 정보를 찾을 수 없습니다");
      }

      const userData = userSnap.data();
      const remainingMoney = userData.remainingMoney || 0;

      if (remainingMoney < amount) {
        throw new Error("잔액이 부족합니다");
      }

      const teamSnap = await transaction.get(teamRef);
      if (!teamSnap.exists()) {
        throw new Error("팀 정보를 찾을 수 없습니다");
      }

      const teamData = teamSnap.data();
      const totalInvestment = teamData.totalInvestment || 0;

      // 트랜잭션 내 업데이트 수행
      transaction.update(userRef, {
        remainingMoney: remainingMoney - amount
      });

      transaction.update(teamRef, {
        totalInvestment: totalInvestment + amount
      });

      transaction.set(investRef, {
        user,
        teamId,
        amount,
        timestamp: new Date()
      });
    });

    alert("투자가 완료되었습니다");
    location.href = "index.html";
  } catch (error) {
    console.error("투자 오류:", error);
    alert(error.message || "투자 처리 중 오류가 발생했습니다");
  }
};
</script>
</body>
</html>
