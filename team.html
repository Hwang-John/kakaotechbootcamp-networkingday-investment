<h2 id="teamName"></h2>
<input id="amount" placeholder="투자금 (10만원 단위)" />
<button onclick="invest()">투자</button>

<script type="module">
import { db } from "./firebase.js";
import {
 doc, getDoc, updateDoc, addDoc, collection
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const user = localStorage.getItem("user");
const params = new URLSearchParams(location.search);
const teamId = params.get("id");

const teamRef = doc(db, "teams", teamId);
const userRef = doc(db, "users", user);

async function loadTeam() {
  const snap = await getDoc(teamRef);
  document.getElementById("teamName").innerText = snap.data().name;
}
loadTeam();

window.invest = async function () {
  const amount = Number(document.getElementById("amount").value);
  if (amount % 100000 !== 0) return alert("10만원 단위");

  const userSnap = await getDoc(userRef);
  if (userSnap.data().remainingMoney < amount)
    return alert("잔액 부족");

  // 중복 투자 방지
  const investId = `${user}_${teamId}`;
  const investRef = doc(db, "investments", investId);
  if ((await getDoc(investRef)).exists())
    return alert("이미 투자함");

  await updateDoc(userRef, {
    remainingMoney: userSnap.data().remainingMoney - amount
  });

  const teamSnap = await getDoc(teamRef);
  await updateDoc(teamRef, {
    totalInvestment: teamSnap.data().totalInvestment + amount
  });

  await addDoc(collection(db, "investments"), {
    user,
    teamId,
    amount
  });

  alert("투자 완료");
  location.href = "index.html";
};
</script>

<h2 id="teamName"></h2>
<input id="amount" placeholder="투자금 (10만원 단위)" />
<button onclick="invest()">투자</button>

<script type="module">
import { db } from "./firebase.js";
import {
 doc, getDoc, updateDoc, addDoc, collection
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const user = localStorage.getItem("user");
const params = new URLSearchParams(location.search);
const teamId = params.get("id");

const teamRef = doc(db, "teams", teamId);
const userRef = doc(db, "users", user);

async function loadTeam() {
  const snap = await getDoc(teamRef);
  document.getElementById("teamName").innerText = snap.data().name;
}
loadTeam();

window.invest = async function () {
  const amount = Number(document.getElementById("amount").value);
  if (amount % 100000 !== 0) return alert("10만원 단위");

  const userSnap = await getDoc(userRef);
  if (userSnap.data().remainingMoney < amount)
    return alert("잔액 부족");

  // 중복 투자 방지
  const investId = `${user}_${teamId}`;
  const investRef = doc(db, "investments", investId);
  if ((await getDoc(investRef)).exists())
    return alert("이미 투자함");

  await updateDoc(userRef, {
    remainingMoney: userSnap.data().remainingMoney - amount
  });

  const teamSnap = await getDoc(teamRef);
  await updateDoc(teamRef, {
    totalInvestment: teamSnap.data().totalInvestment + amount
  });

  await addDoc(collection(db, "investments"), {
    user,
    teamId,
    amount
  });

  alert("투자 완료");
  location.href = "index.html";
};
</script>
