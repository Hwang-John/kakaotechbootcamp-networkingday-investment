<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>팀 투자</title>
  <link rel="stylesheet" href="style.css?v=20260130-3" />
</head>
<body>

<!-- 네비게이션 바 -->
<nav class="navbar">
  <a href="index.html" class="nav-home">홈</a>
  <a href="admin.html" class="nav-admin">관리자</a>
</nav>

<!-- 팀 이름 및 투자 입력 -->
<div class="team-title">
  <h2 id="teamName"></h2>
  <span id="investmentBadge" class="badge"></span>
</div>
<div class="amount-row">
  <input id="amount" placeholder="투자금 (10만원 단위)" inputmode="numeric" />
  <span id="amountHangul" class="amount-hangul"></span>
</div>
<button id="investBtn" type="button" class="btn btn-primary">투자</button>

<!-- 투자 확인 모달 -->
<div id="confirmModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">투자 확인</h3>
    <div class="modal-content">
      <p>팀명: <span id="modalTeamName"></span></p>
      <p>금액: <span id="modalAmount"></span></p>
      <p>남은 금액: <span id="modalRemaining"></span></p>
    </div>
    <div class="modal-actions">
      <button id="modalCancel" type="button" class="modal-btn ghost">취소</button>
      <button id="modalConfirm" type="button" class="modal-btn primary">확인</button>
    </div>
  </div>
</div>

<script type="module">
import { db } from "./firebase.js";
import {
  doc, getDoc, updateDoc, setDoc, collection, runTransaction, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// 사용자 이름과 URL에서 팀 ID 가져오기
const user = localStorage.getItem("user");
const params = new URLSearchParams(location.search);
const teamId = params.get("id");

// null 체크 로직
if (!user) {
  alert("투자자 이름을 입력하여 시작하세요.");
  location.href = "index.html";
}

if (!teamId) {
  alert("잘못된 접근입니다");
  location.href = "index.html";
}

// Firestore 참조 생성
const teamRef = doc(db, "teams", teamId);
const userRef = doc(db, "users", user);
const investmentSettingRef = doc(db, "settings", "investment");

const investBtn = document.getElementById("investBtn");
const confirmModal = document.getElementById("confirmModal");
const modalTeamName = document.getElementById("modalTeamName");
const modalAmount = document.getElementById("modalAmount");
const modalRemaining = document.getElementById("modalRemaining");
const modalCancel = document.getElementById("modalCancel");
const modalConfirm = document.getElementById("modalConfirm");

let currentTeamName = "";
let remainingMoneyCache = 0;
let hasInvested = false;
let isInvestmentOpen = true;

function applyInvestmentStatus() {
  if (isInvestmentOpen) {
    investBtn.disabled = hasInvested;
    return;
  }
  investBtn.disabled = true;
  const badgeElement = document.getElementById("investmentBadge");
  if (badgeElement) {
    badgeElement.className = "badge badge-not-invested";
    badgeElement.innerText = "투자 종료";
  }
}

// 팀 데이터 로드 함수
async function loadTeam() {
  try {
    const [teamSnap, userSnap] = await Promise.all([
      getDoc(teamRef),
      getDoc(userRef)
    ]);

    if (!teamSnap.exists()) {
      alert("존재하지 않는 팀입니다");
      location.href = "index.html";
      return;
    }

    if (!userSnap.exists()) {
      alert("사용자 정보를 찾을 수 없습니다");
      location.href = "index.html";
      return;
    }

    const teamData = teamSnap.data();
    const teamName = teamData.name || "";
    currentTeamName = teamName;
    remainingMoneyCache = userSnap.data().remainingMoney || 0;

    if (teamName === user) {
      alert("본인의 팀은 투자할 수 없습니다");
      location.href = "index.html";
      return;
    }

    document.getElementById("teamName").innerText = teamName;

    const investId = `${user}_${teamId}`;
    const investRef = doc(db, "investments", investId);
    const investSnap = await getDoc(investRef);

    const badgeElement = document.getElementById("investmentBadge");
    badgeElement.className = "badge";
    if (investSnap.exists()) {
      hasInvested = true;
      badgeElement.innerText = "투자 완료";
      badgeElement.classList.add("badge-invested");
    } else {
      hasInvested = false;
      badgeElement.innerText = "미투자";
      badgeElement.classList.add("badge-not-invested");
    }
    applyInvestmentStatus();
  } catch (error) {
    console.error("팀 로드 오류:", error);
    alert("팀 정보를 불러올 수 없습니다");
  }
}

// 로드 팀 데이터 호출
loadTeam();

// 투자 가능 여부 실시간 확인
onSnapshot(investmentSettingRef, (snap) => {
  isInvestmentOpen = snap.exists() ? !!snap.data().isOpen : true;
  if (!isInvestmentOpen) {
    alert("투자가 종료되었습니다.");
  }
  applyInvestmentStatus();
});

const amountInput = document.getElementById("amount");
const amountHangulEl = document.getElementById("amountHangul");

function parseAmount(value) {
  return Number((value || "").replace(/[^\d]/g, ""));
}

function formatAmountInput(value) {
  const digits = (value || "").replace(/[^\d]/g, "");
  if (!digits) return "";
  return `${Number(digits).toLocaleString()}원`;
}

function chunkToKorean(chunk) {
  const digits = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];
  const units = ["", "십", "백", "천"];
  let result = "";
  for (let i = 0; i < 4; i++) {
    const digit = Math.floor(chunk / Math.pow(10, 3 - i)) % 10;
    if (digit === 0) continue;
    const unit = units[3 - i];
    const digitText = (digit === 1 && unit !== "") ? "" : digits[digit];
    result += `${digitText}${unit}`;
  }
  return result;
}

function toKoreanNumber(value) {
  if (!value) return "";
  const bigUnits = ["", "만", "억", "조", "경"];
  let num = value;
  let unitIndex = 0;
  let result = "";

  while (num > 0 && unitIndex < bigUnits.length) {
    const chunk = num % 10000;
    if (chunk > 0) {
      const chunkText = chunkToKorean(chunk);
      result = `${chunkText}${bigUnits[unitIndex]}${result}`;
    }
    num = Math.floor(num / 10000);
    unitIndex += 1;
  }

  return result;
}

amountInput.addEventListener("input", () => {
  amountInput.value = formatAmountInput(amountInput.value);
  const amount = parseAmount(amountInput.value);
  if (!amount) {
    amountHangulEl.innerText = "";
    return;
  }
  amountHangulEl.innerText = `(${toKoreanNumber(amount)}원)`;
});

function openConfirmModal(amount) {
  modalTeamName.innerText = currentTeamName || "-";
  modalAmount.innerText = `${amount.toLocaleString()}원`;
  const remainingAfter = Math.max(remainingMoneyCache - amount, 0);
  modalRemaining.innerText = `${remainingAfter.toLocaleString()}원`;
  confirmModal.classList.add("show");
  confirmModal.setAttribute("aria-hidden", "false");
}

function closeConfirmModal() {
  confirmModal.classList.remove("show");
  confirmModal.setAttribute("aria-hidden", "true");
}

modalCancel.addEventListener("click", closeConfirmModal);
confirmModal.addEventListener("click", (event) => {
  if (event.target === confirmModal) closeConfirmModal();
});

// 투자 로직
async function executeInvestment() {
  if (!isInvestmentOpen) return alert("투자가 종료되었습니다.");
  const amount = parseAmount(amountInput.value);
  if (!amount) return alert("투자금을 입력해주세요");
  if (amount % 100000 !== 0) return alert("10만원 단위로만 입력 가능합니다");
  if (hasInvested) return alert("이미 투자한 팀입니다");
  if (remainingMoneyCache < amount) return alert("잔액이 부족합니다");

  try {
    // Transaction을 사용하여 동시성 문제 방지
    await runTransaction(db, async (transaction) => {
      const investId = `${user}_${teamId}`;
      const investRef = doc(db, "investments", investId);

      // 중복 투자 확인
      const investSnap = await transaction.get(investRef);
      if (investSnap.exists()) {
        throw new Error("이미 투자한 팀입니다");
      }

      // 사용자 및 팀 정보 가져오기
      const userSnap = await transaction.get(userRef);
      if (!userSnap.exists()) {
        throw new Error("사용자 정보를 찾을 수 없습니다");
      }

      const userData = userSnap.data();
      const remainingMoney = userData.remainingMoney || 0;

      if (remainingMoney < amount) {
        throw new Error("잔액이 부족합니다");
      }

      const teamSnap = await transaction.get(teamRef);
      if (!teamSnap.exists()) {
        throw new Error("팀 정보를 찾을 수 없습니다");
      }

      const teamData = teamSnap.data();
      const totalInvestment = teamData.totalInvestment || 0;

      // 트랜잭션 내 업데이트 수행
      transaction.update(userRef, {
        remainingMoney: remainingMoney - amount
      });

      transaction.update(teamRef, {
        totalInvestment: totalInvestment + amount
      });

      transaction.set(investRef, {
        user,
        teamId,
        amount,
        timestamp: new Date()
      });
    });

    alert("투자가 완료되었습니다");
    location.href = "index.html";
  } catch (error) {
    console.error("투자 오류:", error);
    alert(error.message || "투자 처리 중 오류가 발생했습니다");
  }
}

investBtn.addEventListener("click", () => {
  if (!isInvestmentOpen) return alert("투자가 종료되었습니다.");
  const amount = parseAmount(amountInput.value);
  if (!amount) return alert("투자금을 입력해주세요");
  if (amount % 100000 !== 0) return alert("10만원 단위로만 입력 가능합니다");
  if (hasInvested) return alert("이미 투자한 팀입니다");
  if (remainingMoneyCache < amount) return alert("잔액이 부족합니다");

  openConfirmModal(amount);
});

modalConfirm.addEventListener("click", async () => {
  closeConfirmModal();
  await executeInvestment();
});
</script>
</body>
</html>
